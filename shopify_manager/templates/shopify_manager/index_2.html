<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Manager Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional touch */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* Modal backdrop for the pop-up */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- UPDATED HEADER WITH SEO DASHBOARD LINK -->
        <header class="mb-10 flex flex-col md:flex-row md:justify-between md:items-start md:items-center">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2">Shopify Management Dashboard</h1>
                <p class="text-gray-500">Connect to your store and view product SEO analysis.</p>
            </div>
            
            <!-- Link to the SEO/Search Console Dashboard -->
            <a href="{% url 'seo_dashboard_view' %}" 
               class="w-full md:w-auto flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM4.05 6.05a.75.75 0 011.06 0L10 10.94l4.89-4.89a.75.75 0 011.06 1.06L11.06 12l4.89 4.89a.75.75 0 11-1.06 1.06L10 13.06l-4.89 4.89a.75.75 0 11-1.06-1.06L8.94 12l-4.89-4.89a.75.75 0 010-1.06z" clip-rule="evenodd" />
                  <path fill-rule="evenodd" d="M9.75 4.5a.75.75 0 00-1.5 0v3.25a.75.75 0 001.5 0V4.5zM12.5 7.5a.75.75 0 00-1.5 0v3.25a.75.75 0 001.5 0V7.5zM15 10.25a.75.75 0 00-1.5 0v3.25a.75.75 0 001.5 0v-3.25zM7.25 7.5a.75.75 0 00-1.5 0v3.25a.75.75 0 001.5 0V7.5zM4.5 10.25a.75.75 0 00-1.5 0v3.25a.75.75 0 001.5 0v-3.25z" />
                </svg>
                Search Console Dashboard
            </a>
        </header>

        <!-- Configuration Form Card -->
        <div id="config-card" class="container-card bg-white p-6 md:p-8 mb-8 transition-all duration-300">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-3">Store Credentials</h2>
            
            <form id="shopify-config-form" class="space-y-6">
                {% csrf_token %} <!-- Django CSRF token -->
                
                <div>
                    <label for="store-name" class="block text-sm font-medium text-gray-700 mb-1">
                        Shopify Store Name (e.g., my-awesome-shop.myshopify.com)
                    </label>
                    <input type="text" id="store-name" name="storeName" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div>
                    <label for="access-token" class="block text-sm font-medium text-gray-700 mb-1">
                        API Access Token / Admin API Access Token
                    </label>
                    <input type="password" id="access-token" name="accessToken" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div id="message-area" class="text-sm p-3 rounded-lg hidden"></div>

                <button type="submit" id="submit-btn" 
                        class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Connect & Fetch Products
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>

        <!-- Product Display Area -->
        <div id="product-results" class="hidden">
            <div id="product-header" class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Products Overview</h2>
                <div class="flex items-center space-x-4">
                    <span id="product-count" class="text-lg font-medium text-indigo-600">0 Products</span>
                    
                    <!-- Action Buttons Group -->
                    <div class="flex space-x-3">
                        <!-- The Analyze Products button -->
                        <button type="button" id="analyze-btn" 
                                class="px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out hidden">
                            Analyze Products
                        </button>
                        
                        <!-- The Resolve Issues button -->
                        <button type="button" id="resolve-btn" 
                                class="px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out hidden">
                            Resolve Issues
                        </button>
                    </div>
                </div>
            </div>

            <div class="container-card bg-white overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <!-- Headers for the product table -->
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SEO Score</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issues</th>
                            <!-- NEW ACTIONS HEADER -->
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Product rows will be injected here by JavaScript -->
                    </tbody>
                </table>
        </div>
    </div>
     <button id="openChatbot"
        class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-3 rounded-full shadow-lg transition duration-300 flex items-center space-x-2 z-50">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span>Chat Assistant</span>
</button>
<div id="chatbotModal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
    <div class="bg-white w-[95%] md:w-3/4 lg:w-2/3 h-[90vh] rounded-xl overflow-hidden shadow-2xl relative">
        <!-- Close Button -->
        <button id="closeChatbot"
                class="absolute top-3 right-3 text-gray-600 hover:text-gray-800 transition duration-150">
            ‚úñ
        </button>

        <!-- Dynamic Chat Content -->
        <div id="chatbotContent" class="h-full flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-gray-500">Loading Chat Assistant...</p>
            </div>
        </div>
    </div>
</div>
    <!-- Modal for displaying Issues (Pop-up) -->
    <div id="issues-modal" class="modal-backdrop fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transition-all transform duration-300">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-900">Analysis Issues for Product Name</h3>
                    <button onclick="document.getElementById('issues-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <!-- Modal Body -->
                <div class="p-6">
                    <p class="text-sm text-gray-500 mb-4">Recommended actions to improve the SEO score:</p>
                    <div id="modal-issues-content" class="space-y-4 max-h-80 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                        <!-- Issues content will be injected here -->
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t text-right">
                    <button onclick="document.getElementById('issues-modal').classList.add('hidden')" 
                            class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Global variables to store credentials after the first successful connection
        let currentStoreName = '';
        let currentAccessToken = '';

        // --- Helper functions for UI state management ---

        function getUIElements() {
            return {
                submitBtn: document.getElementById('submit-btn'),
                analyzeBtn: document.getElementById('analyze-btn'),
                resolveBtn: document.getElementById('resolve-btn'), 
                loadingSpinner: document.getElementById('loading-spinner'),
                messageArea: document.getElementById('message-area'),
                productResults: document.getElementById('product-results'),
                productTableBody: document.getElementById('product-table-body'),
                issuesModal: document.getElementById('issues-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalContent: document.getElementById('modal-issues-content')
            };
        }

        function setLoadingState(message, buttons) {
            const { loadingSpinner, messageArea, productResults } = getUIElements();
            buttons.forEach(btn => {
                if(btn) { 
                    btn.disabled = true;
                    btn.classList.add('opacity-50');
                }
            });
            loadingSpinner.classList.remove('hidden');
            // Clear all previous message classes
            messageArea.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            // Set pending/loading class
            messageArea.classList.add('bg-indigo-100', 'text-indigo-800');
            messageArea.textContent = message;
            productResults.classList.remove('hidden');
        }

        function resetLoadingState(buttons) {
            const { loadingSpinner } = getUIElements();
            buttons.forEach(btn => {
                if(btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }
            });
            loadingSpinner.classList.add('hidden');
        }
        
        function update_product_on_shopify(productId, productName) {
            const { messageArea, submitBtn, analyzeBtn, resolveBtn } = getUIElements();
            
            console.log(`Attempting to update Product ID: ${productId}, Name: ${productName}`);
            
            // Disable other action buttons temporarily (optional, but good practice)
            setLoadingState(`Requesting update for '${productName}'...`, [submitBtn, analyzeBtn, resolveBtn]);

            // --- Placeholder Logic for Backend Call ---
            // Simulating a successful network call delay
            setTimeout(() => {
                resetLoadingState([submitBtn, analyzeBtn, resolveBtn]);
                
                // Show a success message
                messageArea.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-indigo-100', 'text-indigo-800');
                messageArea.classList.add('bg-blue-100', 'text-blue-800');
                messageArea.textContent = `Product '${productName}' (ID: ${productId}) update initiated. (Please implement the AJAX call to your update endpoint).`;

                // Optionally fade the message away
                // setTimeout(() => {
                // ¬† ¬† messageArea.classList.add('hidden');
                // }, 5000);

            }, 800);
            // --- End Placeholder Logic ---
        }
        
       
        // 1. Initial form submission (Connect & Fetch)
        document.getElementById('shopify-config-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const { submitBtn, analyzeBtn, resolveBtn } = getUIElements();
            const form = e.target;
            const storeName = form.elements['store-name'].value;
            const accessToken = form.elements['access-token'].value;
            
            // Store credentials globally
            currentStoreName = storeName;
            currentAccessToken = accessToken;

            // Set loading state for the initial fetch
            setLoadingState("Connecting to store and fetching products...", [submitBtn, analyzeBtn, resolveBtn]);
            
            // Run the fetch function
            await fetchProducts(storeName, accessToken);

            // Reset loading state after fetchProducts is done.
            resetLoadingState([submitBtn, analyzeBtn, resolveBtn]);
        });

        // 2. "Analyze Products" button click
        document.getElementById('analyze-btn').addEventListener('click', async function(e) {
            if (currentStoreName && currentAccessToken) {
                await analyzeProducts(currentStoreName, currentAccessToken);
            } else {
                const messageArea = document.getElementById('message-area');
                messageArea.classList.remove('hidden');
                messageArea.classList.add('bg-red-100', 'text-red-800');
                messageArea.textContent = 'Please enter store credentials first.';
            }
        });

        // 3. "Resolve Issues" button click
        document.getElementById('resolve-btn').addEventListener('click', async function(e) {
            if (currentStoreName && currentAccessToken) {
                await resolveProductIssues(currentStoreName, currentAccessToken);
            } else {
                const messageArea = document.getElementById('message-area');
                messageArea.classList.remove('hidden');
                messageArea.classList.add('bg-red-100', 'text-red-800');
                messageArea.textContent = 'Please enter store credentials first.';
            }
        });

        async function analyzeProducts(storeName, accessToken) {
            const { submitBtn, analyzeBtn, resolveBtn, messageArea } = getUIElements();
            
            setLoadingState("Running SEO analysis on products...", [submitBtn, analyzeBtn, resolveBtn]);
            
            try {
                const response = await fetch("{% url 'analyze_products' %}", { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ storeName, accessToken })
                });

                const result = await response.json();

                if (response.ok) {
                    // 1. Analysis Success: Update message, then call fetchProducts
                    messageArea.classList.remove('bg-indigo-100', 'text-indigo-800');
                    messageArea.classList.add('bg-green-100', 'text-green-800');
                    messageArea.textContent = result.message || "Product analysis complete. Refreshing updated results...";
                    
                    // CRITICAL STEP: Call fetchProducts to refresh the table with the new scores
                    await fetchProducts(storeName, accessToken, true); 
                    
                } else {
                    // 1. Analysis Failure: Show error
                    messageArea.classList.remove('hidden', 'bg-indigo-100', 'text-indigo-800');
                    messageArea.classList.add('bg-red-100', 'text-red-800');
                    messageArea.textContent = result.error || "An error occurred during product analysis.";
                }

            } catch (error) {
                console.error('Analysis fetch error:', error);
                messageArea.classList.remove('hidden', 'bg-indigo-100', 'text-indigo-800');
                messageArea.classList.add('bg-red-100', 'text-red-800');
                messageArea.textContent = `Network error during analysis: ${error.message}`;
            } finally {
                // Reset loading state only after the entire analysis/fetch sequence is done
                resetLoadingState([submitBtn, analyzeBtn, resolveBtn]);
            }
        }
        
        async function resolveProductIssues(storeName, accessToken) {
            const { submitBtn, analyzeBtn, resolveBtn, messageArea } = getUIElements();
            
            setLoadingState("Resolving critical SEO issues for products...", [submitBtn, analyzeBtn, resolveBtn]);
            
            try {
                // Assuming Django URL is mapped to 'resolve_issues'
                const response = await fetch("{% url 'resolve_product_issues' %}", { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ storeName, accessToken })
                });

                const result = await response.json();

                if (response.ok) {
                    messageArea.classList.remove('bg-indigo-100', 'text-indigo-800');
                    messageArea.classList.add('bg-green-100', 'text-green-800');
                    messageArea.textContent = result.message || "Product issues resolved. Refreshing updated results...";
                    
                    // CRITICAL STEP: Call fetchProducts to refresh the table with the new scores
                    await fetchProducts(storeName, accessToken, true); 
                    
                } else {
                    messageArea.classList.remove('hidden', 'bg-indigo-100', 'text-indigo-800');
                    messageArea.classList.add('bg-red-100', 'text-red-800');
                    messageArea.textContent = result.error || "An error occurred during issue resolution.";
                }

            } catch (error) {
                console.error('Resolution fetch error:', error);
                messageArea.classList.remove('hidden', 'bg-indigo-100', 'text-indigo-800');
                messageArea.classList.add('bg-red-100', 'text-red-800');
                messageArea.textContent = `Network error during resolution: ${error.message}`;
            } finally {
                resetLoadingState([submitBtn, analyzeBtn, resolveBtn]);
            }
        }

        async function fetchProducts(storeName, accessToken, afterAnalysis = false) {
            const { messageArea, analyzeBtn, resolveBtn } = getUIElements();
            
            try {
                const response = await fetch("{% url 'fetch_products' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ storeName, accessToken })
                });

                const result = await response.json();

                // --- UI State Change (Result) ---
                messageArea.classList.remove('hidden', 'bg-indigo-100', 'text-indigo-800');
                messageArea.classList.remove('bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');

                if (response.ok) {
                    messageArea.classList.add('bg-green-100', 'text-green-800');
                    
                    const actionVerb = afterAnalysis ? 'Refreshed' : 'Fetched';
                    messageArea.textContent = result.message || `${actionVerb} product data successfully.`;
                    
                    if (result.products && result.products.length > 0) {
                        renderProducts(result.products);
                        document.getElementById('product-count').textContent = `${result.products.length} Products loaded`;
                        // Show both action buttons if products are loaded
                        analyzeBtn.classList.remove('hidden'); 
                        resolveBtn.classList.remove('hidden');
                    } else {
                        messageArea.textContent += " No products found or returned.";
                        document.getElementById('product-count').textContent = `0 Products loaded`;
                        // Hide buttons if no products
                        analyzeBtn.classList.add('hidden');
                        resolveBtn.classList.add('hidden');
                    }

                } else {
                    messageArea.classList.add('bg-red-100', 'text-red-800');
                    messageArea.textContent = result.error || "An unknown error occurred during fetch.";
                    document.getElementById('product-count').textContent = `0 Products loaded`;
                    // Hide buttons on error
                    analyzeBtn.classList.add('hidden');
                    resolveBtn.classList.add('hidden');
                }

            } catch (error) {
                console.error('Fetch error:', error);
                messageArea.classList.add('bg-red-100', 'text-red-800');
                messageArea.textContent = `Network error: ${error.message}`;
                // Hide buttons on network error
                analyzeBtn.classList.add('hidden');
                resolveBtn.classList.add('hidden');
            }
        }
function resolve_product_issues(productIds) {
    // 1. Validate input: ensure we received a non-empty array
    if (!Array.isArray(productIds) || productIds.length === 0) {
        alert("No product IDs provided to resolve.");
        return;
    }

    // 2. Confirm with the user
    if (!confirm(`Are you sure you want to resolve issues for ${productIds.length} product(s)?`)) {
        return; // Stop if user cancels
    }

    // 3. Use globally stored credentials
    const storeName = currentStoreName;
    const accessToken = currentAccessToken;

    if (!storeName || !accessToken) {
        alert("Cannot resolve issues: Store credentials are not available. Please connect first.");
        return;
    }

    // 4. Define the endpoint
    const resolveEndpoint = 'resolve-single-product-issues/'; // rename as needed on backend

    console.log(`Sending resolve request for products: [${productIds.join(', ')}] to ${resolveEndpoint}`);

    // 5. Make the API call
    fetch(resolveEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            product_ids: productIds,
            storeName: storeName,
            accessToken: accessToken
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // 6. Handle success
        console.log('Resolve successful:', data);

        alert(`Successfully resolved issues for ${productIds.length} product(s). Server message: ${data.message || 'No message'}`);

        // Refresh product list if available
        if (typeof fetchProducts === 'function') {
            fetchProducts(storeName, accessToken, true);
        } else {
            console.error("fetchProducts function is not defined or is not globally accessible.");
        }
    })
    .catch(error => {
        // 7. Handle errors
        console.error('Error resolving product issues:', error);
        alert(`Failed to resolve issues. Error: ${error.message}`);
    });
}


function write_blogs_and_articles(productId) {
    if (!confirm(`Are you sure you want to write blogs and articles for product: "${productId}"?`)) {
        return;
    }

    const writeEndpoint = 'write-blogs-and-articles/';
    const container = document.getElementById("blog-opportunities-container");
    container.innerHTML = `<p>‚è≥ Generating blogs and articles for <b>${productId}</b>...</p>`;

    fetch(writeEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
    console.log('Write successful:', data);

    // Parse opportunities if it‚Äôs a string
    let opportunities = data.opportunities;
    if (typeof opportunities === 'string') {
        try {
            opportunities = JSON.parse(opportunities.replace(/'/g, '"'));
        } catch (err) {
            console.error('JSON parse error:', err);
            container.innerHTML = `<p style="color:red;">‚ö†Ô∏è Error parsing opportunities data</p>`;
            return;
        }
    }

    if (!opportunities || !Array.isArray(opportunities)) {
        container.innerHTML = `<p>No opportunities returned.</p>`;
        return;
    }

    // Build display content
    let html = `<h3>‚úÖ Opportunities for Product: ${productId}</h3>`;
    html += `<p>${data.message || ''}</p>`;

    opportunities.forEach((item, index) => {
        html += `
        <div style="border:1px solid #ccc; border-radius:8px; padding:12px; margin:10px 0;">
            <h4>üîπ Opportunity ${index + 1}: ${item.opportunity || 'N/A'}</h4>
            <p><b>Product:</b> ${item.product_name || 'N/A'}</p>
            <p><b>Proposed Actions:</b> ${item.proposed_actions || 'N/A'}</p>
        `;

        if (item.article_html) {
            html += `<div><b>üìù Suggested Article:</b><br>${item.article_html}</div>`;
        }
        if (item.new_description_html) {
            html += `<div><b>üìÑ New Description:</b><br>${item.new_description_html}</div>`;
        }
        if (item.new_alt_texts) {
            html += `<div><b>üñºÔ∏è New Alt Texts:</b><ul>${item.new_alt_texts.map(t => `<li>${t}</li>`).join('')}</ul></div>`;
        }
        if (item.new_meta_title || item.new_meta_description) {
            html += `<div><b>üîñ Meta Title:</b> ${item.new_meta_title || 'N/A'}<br>
                     <b>Meta Description:</b> ${item.new_meta_description || 'N/A'}</div>`;
        }

        html += `</div>`;
    });

    container.innerHTML = html;
})
    .catch(error => {
        console.error('Error writing blogs and articles:', error);
        container.innerHTML = `<p style="color:red;">‚ùå Failed: ${error.message}</p>`;
    });
}

function renderProducts(products) {
    const tableBody = document.getElementById('product-table-body');
    tableBody.innerHTML = ''; // Clear previous results
    const RESOLVE_THRESHOLD = 95;
    products.forEach((product, index) => {
        const mainRow = document.createElement('tr');
        mainRow.classList.add('hover:bg-gray-100');

        // --- Product Status Badge ---
        let statusClasses = '';
        if (product.status === 'Active') statusClasses = 'bg-green-100 text-green-800';
        else if (product.status === 'Draft') statusClasses = 'bg-yellow-100 text-yellow-800';
        else statusClasses = 'bg-gray-100 text-gray-800';

        // --- SEO Score Color ---
        let scoreColorClass = 'text-indigo-600'; 
        const score = parseFloat(product["SEO Score"]);
        if (score >= 80) scoreColorClass = 'text-green-600';
        else if (score >= 50) scoreColorClass = 'text-yellow-600';
        else scoreColorClass = 'text-red-600';

        // --- Issues Setup ---
        const issuesArray = product["issues"] || []; 
        const issueCount = Array.isArray(issuesArray) ? issuesArray.length : 0;
        const safeProductName = product["Product Name"].replace(/'/g, "\\'");
        const safeProductId = product["id"].replace(/'/g, "\\'");
        // --- Dynamic color for the Checks button based on SEO Score ---
        let checksButtonColor = 'text-red-600 hover:text-red-800';
        if (score > 90) {
            checksButtonColor = 'text-green-600 hover:text-green-800';
        } else if (score >= 50) {
            checksButtonColor = 'text-yellow-600 hover:text-yellow-800';
        }
        let isDisabled = '';
        let resolveButtonClasses = '';
        let resolveButtonHTML;

        if (score >= RESOLVE_THRESHOLD || issueCount === 0) {
            isDisabled = ' disabled ';
            resolveButtonClasses = 'opacity-50 cursor-not-allowed hover:bg-green-500';

            // Wrap in a container to enable hover tooltip even when button is disabled
            resolveButtonHTML = `
                <div class="relative group inline-block">
                    <button class="px-3 py-1 bg-green-500 text-white text-xs font-medium rounded-lg shadow-md hover:bg-green-600 transition duration-150 ease-in-out w-23 ${resolveButtonClasses}" ${isDisabled}>
                        Resolve Issues
                    </button>
                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 
                                hidden group-hover:block bg-gray-800 text-white text-sm 
                                rounded py-1 px-2 whitespace-nowrap shadow-lg z-10">
                        Product is already optimized
                    </div>
                </div>
            `;
        } else {
            resolveButtonClasses = ' hover:bg-green-600 ';
            resolveButtonHTML = `
                <button onclick="resolve_product_issue('${safeProductName}')"
                        class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs font-medium rounded-lg shadow-md transition duration-150 ease-in-out w-23 ${resolveButtonClasses}">
                    Resolve Issues
                </button>
            `;
        }
        
        // --- Main Product Row ---
        mainRow.innerHTML = `
            <td class="px-6 py-4 text-base font-medium text-gray-900">${product["Product Name"]}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm ${scoreColorClass} font-bold">${product["SEO Score"]}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses}">
                    ${product.status}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                ${
                    issueCount > 0
                    ? `<button id="issues-btn-${index}" 
                               class="text-sm font-medium ${checksButtonColor} hover:underline transition duration-150">
                        ${issueCount} Checks ‚ñº
                       </button>`
                    : `<span class="text-xs text-green-500 font-semibold">None Found</span>`
                }
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                <button onclick="update_product_on_shopify(${product['id']}, '${safeProductName}')"
                        class="px-3 py-1 bg-blue-500 text-white text-xs font-medium rounded-lg shadow-md hover:bg-blue-600 transition duration-150 ease-in-out w-23">
                    Update
                </button>
                ${resolveButtonHTML}
                <button onclick="write_blogs_and_articles('${safeProductId}')"
                        class="px-3 py-1 bg-blue-500 text-white text-xs font-medium rounded-lg shadow-md hover:bg-blue-600 transition duration-150 ease-in-out w-23">
                    Find SEO Opportunities
                </button>
                <div id="blog-opportunities-container" style="margin-top: 20px;"></div>
            </td>
        `;

        // --- Expandable Details Row ---
        const detailsRow = document.createElement('tr');
        detailsRow.id = `details-row-${index}`;
        detailsRow.classList.add('hidden', 'bg-gray-50');
        detailsRow.innerHTML = `
    <td colspan="5" class="px-6 py-4">
        <div id="issues-content-${index}" class="p-4 border border-gray-200 rounded-lg text-sm text-gray-700 mb-4">
            <!-- Dynamic issues go here -->
        </div>
        <div id="blog-opportunities-container-${index}" class="p-4 border border-indigo-100 rounded-lg text-sm text-gray-800 bg-indigo-50 hidden">
            <!-- SEO opportunities (blogs/articles/meta updates) will appear here -->
        </div>
    </td>
`;

        // Append both rows
        tableBody.appendChild(mainRow);
        tableBody.appendChild(detailsRow);

        // --- Toggle Event for Issues ---
        if (issueCount > 0) {
            document.getElementById(`issues-btn-${index}`).addEventListener('click', () => {
                const detailsEl = document.getElementById(`details-row-${index}`);
                const contentEl = document.getElementById(`issues-content-${index}`);
                const btn = document.getElementById(`issues-btn-${index}`);

                // Toggle visibility
                detailsEl.classList.toggle('hidden');

                // Update arrow icon
                btn.innerHTML = detailsEl.classList.contains('hidden')
                    ? `${issueCount} Checks ‚ñº`
                    : `${issueCount} Checks ‚ñ≤`;

                // Populate issues if visible
                if (!detailsEl.classList.contains('hidden')) {
                    renderIssueDetails(contentEl, issuesArray, product["SEO Score"]);
                }
            });
        }
    });
}

function renderIssueDetails(container, issuesArray, seoScore = null) {
    container.innerHTML = '';

    if (!Array.isArray(issuesArray) || issuesArray.length === 0) {
        container.innerHTML = `
            <p class="text-green-600 font-medium">No issues found. SEO looks great!</p>
            ${
                seoScore !== null
                    ? `<div class="mt-4 p-4 bg-green-50 border border-green-300 rounded-lg text-green-800 font-semibold">
                           Overall SEO Score: ${seoScore}/100
                       </div>`
                    : ''
            }
        `;
        return;
    }

    const list = document.createElement('ul');
    list.className = 'divide-y divide-gray-200';

    issuesArray.forEach((issue, i) => {
        const li = document.createElement('li');
        li.className = 'py-2';

        // Extract score (e.g., "5/10" or "0/5")
        const scoreMatch = issue.match(/(\d+)\s*\/\s*(\d+)\s*$/);
        let scoreValue = null;
        let scoreText = '';
        let borderColor = 'border-green-300';
        let bgColor = 'bg-green-50';
        let scoreColor = 'bg-green-100 text-green-800 border border-green-300';

        if (scoreMatch) {
            scoreValue = parseInt(scoreMatch[1], 10);
            scoreText = scoreMatch[0];
            issue = issue.replace(/\s*\d+\s*\/\s*\d+\s*$/, ''); // remove score text

            if (scoreValue === 0) {
                borderColor = 'border-red-300';
                bgColor = 'bg-red-50';
                scoreColor = 'bg-red-100 text-red-800 border border-red-300';
            }
        }

        li.innerHTML = `
            <div class="relative p-3 border rounded-lg ${borderColor} ${bgColor} transition-colors duration-300">
                <p class="text-sm font-semibold text-gray-800 mb-1">Check ${i + 1}:</p>
                <p class="text-sm text-gray-700 pr-14">${issue.trim()}</p>
                ${
                    scoreText
                        ? `<span class="absolute top-2 right-3 text-xs font-semibold px-2 py-1 rounded-lg ${scoreColor}">
                               ${scoreText}
                           </span>`
                        : ''
                }
            </div>
        `;

        list.appendChild(li);
    });

    // Add final SEO Score summary box
    if (seoScore !== null) {
        let scoreBg = 'bg-green-50 border-green-300 text-green-800';
        if (seoScore < 50) scoreBg = 'bg-red-50 border-red-300 text-red-700';
        else if (seoScore < 80) scoreBg = 'bg-yellow-50 border-yellow-300 text-yellow-700';

        const summaryLi = document.createElement('li');
        summaryLi.className = 'pt-4';
        summaryLi.innerHTML = `
            <div class="p-4 border rounded-lg ${scoreBg} font-semibold text-center text-base">
                Overall SEO Score: ${seoScore}/100
            </div>
        `;
        list.appendChild(summaryLi);
    }

    container.appendChild(list);
}
const openChatbotBtn = document.getElementById('openChatbot');
const closeChatbotBtn = document.getElementById('closeChatbot');
const chatbotModal = document.getElementById('chatbotModal');
const chatbotContent = document.getElementById('chatbotContent');

// Open modal and load chatbot HTML
openChatbotBtn.addEventListener('click', async () => {
    chatbotModal.classList.remove('hidden');
    chatbotContent.innerHTML = `
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-500">Loading Chat Assistant...</p>
        </div>
    `;

    try {
        // Fetch chatbot HTML from Django route
        const response = await fetch('chat-interface/');
        if (!response.ok) throw new Error('Failed to load chatbot.');

        const html = await response.text();

        // Use a temporary div to parse HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;

        // Inject parsed content into modal
        chatbotContent.innerHTML = tempDiv.innerHTML;

        // Execute <script> tags in the loaded HTML
        const scripts = chatbotContent.querySelectorAll('script');
        scripts.forEach((oldScript) => {
            const newScript = document.createElement('script');
            if (oldScript.src) {
                newScript.src = oldScript.src;
            } else {
                newScript.textContent = oldScript.textContent;
            }
            document.body.appendChild(newScript);
            newScript.remove(); // clean up after execution
        });

    } catch (error) {
        chatbotContent.innerHTML = `
            <div class="text-center text-red-600">
                ‚ö†Ô∏è Unable to load Chat Assistant. Please try again later.
            </div>`;
        console.error(error);
    }
});

// Close modal
closeChatbotBtn.addEventListener('click', () => {
    chatbotModal.classList.add('hidden');
});

// Close modal when clicking outside
chatbotModal.addEventListener('click', (e) => {
    if (e.target === chatbotModal) {
        chatbotModal.classList.add('hidden');
    }
});
    </script>
</body>
</html>
